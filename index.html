<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Galaxy Games</title>
  <style>
    :root{
      --bg0:#020617;
      --bg1:#0b1226;
      --panel:rgba(2,6,23,.72);
      --panel2:rgba(15,23,42,.70);
      --stroke:rgba(148,163,184,.20);
      --stroke2:rgba(148,163,184,.30);
      --text:#f8fafc;
      --muted:#94a3b8;
      --good:#22c55e;
      --bad:#ef4444;
      --accent:#38bdf8;
      --accent2:#a855f7;
      --shadow:0 28px 90px rgba(2,6,23,.75);
      --r-lg:22px;
      --r-md:16px;
      --r-sm:12px;
      --blur: blur(12px);
      --focus: 0 0 0 3px rgba(56,189,248,.22);
    }
    [data-theme="neon"]{
      --panel:rgba(2,6,23,.62);
      --panel2:rgba(15,23,42,.58);
      --stroke:rgba(56,189,248,.25);
      --stroke2:rgba(168,85,247,.28);
    }
    [data-theme="midnight"]{
      --bg:#050816;
      --panel:rgba(3,7,18,.72);
      --panel2:rgba(15,23,42,.60);
      --stroke:rgba(148,163,184,.18);
      --stroke2:rgba(56,189,248,.18);
      --accent:#38bdf8;
      --accent2:#22c55e;
      --shadow:0 28px 90px rgba(0,0,0,.75);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 18% 12%, rgba(56,189,248,.18), transparent 60%),
        radial-gradient(900px 700px at 82% 18%, rgba(168,85,247,.14), transparent 55%),
        radial-gradient(800px 700px at 60% 92%, rgba(34,197,94,.08), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0) 55%, #000);
      background-attachment: fixed;
      display:flex;
      justify-content:center;
      align-items:stretch;
    }

    /* Galaxy UI: bigger scroll + more room for picking */
.main{
  overflow: auto;
}
.main::-webkit-scrollbar{
  width: 14px;
  height: 14px;
}
.main::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.18);
  border: 3px solid rgba(0,0,0,.25);
  border-radius: 999px;
}
.main::-webkit-scrollbar-track{
  background: rgba(0,0,0,.18);
  border-radius: 999px;
}
.grid{
  gap: 14px !important;
}
.tile{
  padding: 14px !important;
  min-height: 78px;
}
.tile .name{
  font-size: 14px;
  line-height: 1.2;
}

    /* Galaxy Music: full-width (screen-wide) layout */
/* Remove max-width constraints on the main content panel/card */
.main, .main .card, .main .panel, .main .wrap, .main .container{
  max-width: none !important;
  width: 100% !important;
}

/* Let the main card stretch and reduce wasted side padding */
.main .card{
  margin-left: 0 !important;
  margin-right: 0 !important;
}
.main{
  padding-left: 0 !important;
  padding-right: 0 !important;
}

/* Make the Music tab itself span full available width */
[data-tab="music"], #music, .music, .music-page, .tab-music{
  max-width: none !important;
  width: 100% !important;
}

/* Expand filter rows / dropdown rows */
.music .filters, .music-filters, .filters, .toolbar, .music-toolbar{
  max-width: none !important;
  width: 100% !important;
}

/* Expand the results area and show more per row */
.songs, .music-grid, .results, .list, .grid{
  max-width: none !important;
  width: 100% !important;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)) !important;
}

/* Slightly bigger cards/rows for easier selection */
.song, .tile{
  min-height: 96px !important;
  padding: 16px !important;
}

/* Give the music section edge-to-edge breathing room */
.main .card > *{
  max-width: none !important;
}
.music, [data-tab="music"]{
  padding-left: 18px !important;
  padding-right: 18px !important;
}

/* On large screens, go truly wide by widening the top content row too */
@media (min-width: 1100px){
  .main .card{
    border-radius: 22px;
  }
  .music, [data-tab="music"]{
    padding-left: 26px !important;
    padding-right: 26px !important;
  }
}

    /* App layout */
    .shell{
      width:min(1480px, 100%);
      height:100vh;
      padding:18px;
      display:grid;
      grid-template-columns: 92px minmax(0,1fr);
      gap:16px;
    }

    /* Sidebar */
    .side{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: 26px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
      padding:12px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:space-between;
      overflow:hidden;
    }
    .brand{
      width:44px;height:44px;border-radius:999px;
      display:grid;place-items:center;
      font-weight:900; letter-spacing:.08em;
      background: radial-gradient(circle at 30% 30%, var(--accent), rgba(15,23,42,.9));
      box-shadow: 0 14px 40px rgba(56,189,248,.25);
      border: 1px solid rgba(56,189,248,.22);
      user-select:none;
    }
    .nav{
      margin-top:8px;
      display:grid;
      gap:10px;
    }
    .iconbtn{
      all:unset;
      width:44px;height:44px;border-radius:999px;
      display:grid;place-items:center;
      color:var(--muted);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, color .12s ease, box-shadow .12s ease;
    }
    .iconbtn:hover{ background: rgba(15,23,42,.55); color:var(--text); transform: translateY(-1px); }
    .iconbtn.active{
      color:#071222;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 12px 36px rgba(56,189,248,.22);
    }
    .clock{
      text-align:center;
      color:var(--muted);
      font-size:.74rem;
      display:grid; gap:4px;
      padding: 8px 0 2px;
    }
    .clock .t{ font-weight:700; letter-spacing:.12em; font-size:.88rem; color:rgba(248,250,252,.92); }

    /* Main */
    .main{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: 26px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
      padding: 16px 18px 18px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .top{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .titleblock{ display:grid; gap:6px; min-width:260px; }
    .titleblock .h{
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.10em;
      font-size: 1.22rem;
    }
    .titleblock .sub{ color:var(--muted); font-size:.9rem; max-width: 56ch; }
    .pills{ display:flex; flex-wrap:wrap; gap:8px; }
    .pill{
      font-size:.76rem;
      color:rgba(148,163,184,.95);
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.45);
      padding: 5px 10px;
      border-radius:999px;
      user-select:none;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .seg{
      display:inline-flex;
      padding:4px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(15,23,42,.45);
      gap:4px;
    }
    .seg button{
      all:unset;
      cursor:pointer;
      padding: 7px 12px;
      border-radius:999px;
      font-size:.86rem;
      color:var(--muted);
      transition: background .12s ease, color .12s ease, transform .12s ease, box-shadow .12s ease;
    }
    .seg button:hover{ color:var(--text); transform: translateY(-1px); }
    .seg button.active{
      color:#071222;
      background: radial-gradient(circle at top left, var(--accent), var(--accent2));
      box-shadow: 0 10px 22px rgba(56,189,248,.18);
      font-weight:700;
    }

    .btn{
      border:1px solid var(--stroke);
      background: rgba(15,23,42,.45);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-size:.86rem;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(56,189,248,.32); }
    .btn:focus{ outline:none; box-shadow: var(--focus); }
    .btn.primary{
      border:none;
      color:#071222;
      background: radial-gradient(circle at top left, var(--accent), var(--accent2));
      font-weight:800;
      box-shadow: 0 14px 34px rgba(56,189,248,.18);
    }
    .btn.ghost{ color:var(--muted); background: transparent; border:1px solid rgba(148,163,184,.26); }
    .btn.icon{ padding:9px 11px; font-size:.92rem; }

    /* Content */
    .panel{
      margin-top:14px;
      flex:1;
      border-radius: var(--r-lg);
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      padding: 16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .tab{ display:none; height:100%; overflow:hidden; }
    .tab.active{ display:flex; flex-direction:column; gap:14px; }

    /* Reusable */
    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .h2{ font-size:1.06rem; font-weight:850; letter-spacing:.02em; }
    .hint{ color:var(--muted); font-size:.86rem; }
    .spacer{ flex:1; }

    .inputwrap{ position:relative; width:min(360px, 100%); }
    input[type="text"], select{
      width:100%;
      border:1px solid rgba(148,163,184,.26);
      background: rgba(15,23,42,.55);
      color: var(--text);
      padding: 11px 38px 11px 12px;
      border-radius: 999px;
      font-size:.9rem;
      outline:none;
    }
    input[type="text"]:focus, select:focus{ box-shadow: var(--focus); border-color: rgba(56,189,248,.42); }
    .inputwrap .ico{
      position:absolute; right:12px; top:50%; transform: translateY(-50%);
      color: rgba(148,163,184,.9);
      font-size:.95rem;
      pointer-events:none;
    }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.45);
      color: var(--muted);
      padding: 6px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:.82rem;
      user-select:none;
      transition: transform .12s ease, border-color .12s ease, color .12s ease;
    }
    .chip:hover{ transform: translateY(-1px); border-color: rgba(56,189,248,.28); color: var(--text); }
    .chip.active{ color:#071222; border:none; background: linear-gradient(135deg, var(--accent), var(--accent2)); font-weight:800; }

    /* Cards grids */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap:12px;
      overflow:auto;
      padding-right: 4px;
    }
    .card{
      border-radius: var(--r-md);
      border:1px solid rgba(148,163,184,.16);
      background: rgba(15,23,42,.46);
      box-shadow: 0 10px 28px rgba(2,6,23,.42);
      padding:12px;
      display:grid;
      gap:10px;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(56,189,248,.26);
      box-shadow: 0 16px 36px rgba(2,6,23,.55);
    }
    .card .topline{ display:flex; align-items:center; gap:10px; justify-content:space-between; }
    .card .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .avatar{
      width:34px;height:34px;border-radius: 12px;
      background: rgba(2,6,23,.65);
      border:1px solid rgba(148,163,184,.18);
      background-size:cover; background-position:center;
      flex:0 0 auto;
    }
    .meta{ min-width:0; display:grid; gap:2px; }
    .meta .name{ font-weight:800; font-size:.92rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .meta .sub{ color:var(--muted); font-size:.78rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .kbar{ font-size:.72rem; color: rgba(148,163,184,.9); border:1px solid rgba(148,163,184,.22); padding:3px 8px; border-radius:999px; }

    .card .actions{ display:flex; gap:8px; justify-content:flex-end; }
    .smallbtn{
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.45);
      color: var(--text);
      padding: 7px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-size:.82rem;
    }
    .smallbtn.primary{ border:none; color:#071222; background: linear-gradient(135deg, var(--accent), var(--accent2)); font-weight:900; }
    .smallbtn.ghost{ color:var(--muted); background: transparent; }
    .star{
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.45);
      color: var(--muted);
      width:34px;height:34px;border-radius: 999px;
      display:grid; place-items:center;
      cursor:pointer;
      transition: transform .12s ease, color .12s ease, border-color .12s ease;
      flex: 0 0 auto;
    }
    .star:hover{ transform: translateY(-1px); border-color: rgba(56,189,248,.26); color: var(--text); }
    .star.on{ color:#071222; border:none; background: linear-gradient(135deg, #fbbf24, #fb7185); font-weight:900; }

    /* Home */
    .hero{
      display:grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap:14px;
      align-items:stretch;
    }
    .heroBox{
      border-radius: var(--r-lg);
      border:1px solid rgba(148,163,184,.18);
      background: linear-gradient(135deg, rgba(15,23,42,.55), rgba(30,64,175,.25));
      padding: 16px;
      display:grid;
      gap:10px;
      overflow:hidden;
      position:relative;
    }
    .heroBox:before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(700px 300px at 20% 0%, rgba(56,189,248,.18), transparent 60%),
                  radial-gradient(600px 260px at 90% 10%, rgba(168,85,247,.12), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }
    .heroBox > *{ position:relative; }
    .heroTitle{ font-size: 3rem; font-weight:900; letter-spacing:.01em; text-transform:none; }
    .heroTitle .accent{ color: var(--accent); }
        .heroSubtitle{ margin-top:6px; font-size:1.05rem; color: rgba(226,232,240,.78); letter-spacing:.02em; }
    .stats{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      margin-top:4px;
    }
    .stat{
      border-radius: 16px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.45);
      padding:10px;
      display:grid;
      gap:2px;
    }
    .stat .n{ font-weight:900; font-size:1.05rem; }
    .stat .l{ color:var(--muted); font-size:.78rem; }

    /* Music specific */
    .musicMini{
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.45);
      border-radius: 18px;
      padding: 10px 12px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .musicMini .now{ min-width:0; display:grid; gap:2px; }
    .musicMini .now .t{ font-weight:900; font-size:.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .musicMini .now .a{ color:var(--muted); font-size:.78rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .musicMini .ctrl{ display:flex; gap:8px; align-items:center; flex:0 0 auto; }
    .range{ width:220px; max-width: 45vw; }
    .link{ color: var(--accent); text-decoration:none; font-size:.82rem; }
    .link:hover{ text-decoration:underline; }
    .badge{
      font-size:.72rem;
      color:rgba(148,163,184,.95);
      border:1px solid rgba(148,163,184,.20);
      padding:3px 8px;
      border-radius: 999px;
      display:inline-flex;
      gap:6px;
      align-items:center;
    }

    /* Overlay */
    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:stretch;
      justify-content:center;
      background: rgba(0,0,0,.88);
      backdrop-filter: blur(10px);
      z-index: 9999;
    }
    .overlay .frame{
      width: min(1400px, 100%);
      height: 100%;
      display:flex;
      flex-direction:column;
    }
    .obar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      background: rgba(2,6,23,.78);
      border-bottom: 1px solid rgba(148,163,184,.18);
    }
    .obar .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .obar .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(56,189,248,.85);
      box-shadow: 0 0 22px rgba(56,189,248,.35);
      flex:0 0 auto;
    }
    .obar .ttl{
      font-weight:900; font-size:.92rem;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 55vw;
    }
    .obar .right{ display:flex; gap:8px; align-items:center; }
    .obar .kb{ display:none; }
    .obarbtn{
      border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.45);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-size:.84rem;
    }
    .obarbtn:hover{ border-color: rgba(56,189,248,.30); }
    .overlay iframe{
      flex:1;
      width:100%;
      border:none;
      background:#000;
    }
    .loading{
      position:absolute;
      inset:0;
      display:none;
      place-items:center;
      pointer-events:none;
      background: radial-gradient(circle at center, rgba(2,6,23,.42), transparent 55%);
    }
    .spinner{
      width:44px;height:44px;border-radius:999px;
      border: 3px solid rgba(148,163,184,.28);
      border-top-color: rgba(56,189,248,.85);
      animation: spin 1s linear infinite;
      box-shadow: 0 18px 40px rgba(2,6,23,.4);
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* Command palette */
    .kmodal{
      position:fixed; inset:0;
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding: 10vh 14px 14px;
      background: rgba(0,0,0,.60);
      backdrop-filter: blur(10px);
      z-index: 10010;
    }
    .kpanel{
      width:min(720px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.80);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .khead{ padding: 12px; border-bottom: 1px solid rgba(148,163,184,.14); display:flex; gap:10px; align-items:center; }
    .khead input{
      border-radius: 14px;
      padding: 12px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.45);
      color: var(--text);
      width:100%;
      outline:none;
      font-size:.95rem;
    }
    .klist{ max-height: 48vh; overflow:auto; }
    .kitem{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(148,163,184,.10);
      cursor:pointer;
    }
    .kitem:hover{ background: rgba(56,189,248,.08); }
    .kitem .l{ display:flex; gap:10px; align-items:center; min-width:0; }
    .kitem .n{ font-weight:850; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .kitem .s{ color:var(--muted); font-size:.8rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .kitem .r{ display:flex; gap:8px; align-items:center; flex:0 0 auto; }

    /* Small screens */
    @media (max-width: 920px){
      .shell{ grid-template-columns: 70px minmax(0,1fr); padding: 10px; }
      .hero{ grid-template-columns: 1fr; }
      .stats{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    @media (max-width: 620px){
      .main{ padding: 12px; }
      .panel{ padding: 12px; }
      .stats{ grid-template-columns: 1fr; }
      .range{ display:none; }
    }
  
    .inlinelink{color:var(--accent); text-decoration:none; border-bottom:1px dashed var(--stroke2)}
    .inlinelink:hover{border-bottom-style:solid}

    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:18px; background: rgba(2,6,23,.66); z-index:50}
    .modal[aria-hidden="false"]{display:flex}
    .modalCard{width:min(920px, 100%); background: var(--panel); border:1px solid var(--stroke); border-radius: 22px; box-shadow: var(--shadow); backdrop-filter: var(--blur); overflow:hidden}
    .modalHead{display:flex; align-items:center; justify-content:space-between; padding:16px 16px 10px 16px; border-bottom:1px solid var(--stroke)}
    .modalBody{padding:14px 16px 16px}
    .setGrid{display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:14px}
    .setGroup{background: var(--panel2); border:1px solid var(--stroke); border-radius: 16px; padding:14px}
    .h3{font-weight:750; margin:0 0 10px 0}
    .setRow{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 0}
    .setRow.toggle input{width:18px; height:18px}

/* =========================
   Spotify-style Music UI
   ========================= */
[data-tab="music"]{
  --sp-bg:#0b0b0c;
  --sp-panel:#121212;
  --sp-panel2:#181818;
  --sp-border:rgba(255,255,255,.08);
  --sp-text:rgba(255,255,255,.92);
  --sp-muted:rgba(255,255,255,.64);
  --sp-green:#1db954;
}
[data-tab="music"] .spHeader{
  padding: 10px 10px 0;
  border-radius: 18px;
  background: radial-gradient(900px 420px at 20% 0%, rgba(29,185,84,.16), transparent 55%),
              radial-gradient(700px 340px at 70% 10%, rgba(56,189,248,.10), transparent 58%);
}
[data-tab="music"] .spTitle{
  font-size: 32px;
  font-weight: 900;
  letter-spacing: -0.02em;
}
[data-tab="music"] .spSub{
  margin-top: 6px;
  color: var(--sp-muted);
  font-size: 14px;
}
[data-tab="music"] .spToolbar{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  padding: 10px;
  border-radius: 18px;
  background: rgba(0,0,0,.18);
  border:1px solid var(--sp-border);
}
[data-tab="music"] .spSearch{
  flex: 1 1 320px;
  min-width: 260px;
  display:flex;
  align-items:center;
  gap:10px;
  padding: 10px 12px;
  border-radius: 999px;
  border:1px solid var(--sp-border);
  background: rgba(0,0,0,.28);
}
[data-tab="music"] .spSearchIcon{ opacity:.75; }
[data-tab="music"] #musicSearch{
  width:100%;
  border:0;
  outline:none;
  background: transparent;
  color: var(--sp-text);
  font-size: 14px;
  padding: 0;
}
[data-tab="music"] .spFilters{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:flex-end;
}
[data-tab="music"] .spSelect{
  display:flex;
  align-items:center;
  gap:8px;
  padding: 8px 10px;
  border-radius: 999px;
  border:1px solid var(--sp-border);
  background: rgba(0,0,0,.20);
  color: var(--sp-muted);
  font-size: 12px;
}
[data-tab="music"] .spSelect span{ opacity:.9; }
[data-tab="music"] .spSelect select{
  border:0 !important;
  background: transparent !important;
  color: var(--sp-text) !important;
  padding: 0 !important;
  border-radius: 0 !important;
  font-size: 13px !important;
  outline:none !important;
}
[data-tab="music"] .spChipsRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
  padding: 0 10px;
}
[data-tab="music"] .spTableHead{
  margin-top: 4px;
  display:grid;
  grid-template-columns: 34px minmax(260px, 1.6fr) minmax(160px, 1fr) 90px 160px;
  gap:12px;
  padding: 10px 12px;
  border-bottom: 1px solid var(--sp-border);
  color: var(--sp-muted);
  font-size: 12px;
  letter-spacing: .06em;
  text-transform: uppercase;
}
[data-tab="music"] .spList{
  overflow:auto;
  padding: 0 6px 120px;
}
[data-tab="music"] .spTrack{
  display:grid;
  grid-template-columns: 34px minmax(260px, 1.6fr) minmax(160px, 1fr) 90px 160px;
  gap:12px;
  align-items:center;
  padding: 10px 12px;
  border-radius: 12px;
  cursor:pointer;
}
[data-tab="music"] .spTrack:hover{
  background: rgba(255,255,255,.06);
}
[data-tab="music"] .spNum{
  color: var(--sp-muted);
  font-variant-numeric: tabular-nums;
}
[data-tab="music"] .spTitleCell{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
[data-tab="music"] .spArt{
  width: 44px;
  height: 44px;
  border-radius: 8px;
  background: rgba(255,255,255,.06);
  border: 1px solid var(--sp-border);
  background-size: cover;
  background-position: center;
  flex: 0 0 auto;
}
[data-tab="music"] .spMeta{
  min-width:0;
  display:grid;
  gap:2px;
}
[data-tab="music"] .spMeta .t{
  font-weight: 800;
  color: var(--sp-text);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
[data-tab="music"] .spMeta .a{
  color: var(--sp-muted);
  font-size: 12px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
[data-tab="music"] .spAlbum{
  color: var(--sp-muted);
  font-size: 12px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
[data-tab="music"] .spPrice{
  color: var(--sp-muted);
  font-size: 12px;
  text-align:right;
  font-variant-numeric: tabular-nums;
}
[data-tab="music"] .spBtns{
  display:flex;
  justify-content:flex-end;
  gap:8px;
}
[data-tab="music"] .spBtn{
  border:1px solid var(--sp-border);
  background: rgba(0,0,0,.22);
  color: var(--sp-text);
  padding: 8px 10px;
  border-radius: 999px;
  cursor:pointer;
  font-size: 12px;
}
[data-tab="music"] .spBtn:hover{ transform: translateY(-1px); }
[data-tab="music"] .spBtn.green{
  border: 0;
  background: linear-gradient(135deg, var(--sp-green), rgba(29,185,84,.70));
  color:#071222;
  font-weight: 900;
}
[data-tab="music"] .spBtn.icon{
  width: 38px;
  padding: 8px 0;
  display:grid;
  place-items:center;
}
[data-tab="music"] .spBtn[disabled]{
  opacity:.5;
  cursor:not-allowed;
  transform:none;
}

/* Player bar */
[data-tab="music"] .spPlayer{
  position: sticky;
  bottom: 0;
  left: 0;
  right: 0;
  margin-top: 10px;
  display:none;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding: 12px;
  border-radius: 18px;
  background: linear-gradient(180deg, rgba(24,24,24,.95), rgba(18,18,18,.95));
  border:1px solid var(--sp-border);
  backdrop-filter: blur(10px);
}
[data-tab="music"] .spNow{
  display:flex;
  align-items:center;
  gap:10px;
  min-width: 220px;
}
[data-tab="music"] .spNowArt{
  width: 48px;
  height: 48px;
  border-radius: 10px;
  border:1px solid var(--sp-border);
  background: rgba(255,255,255,.06);
  background-size: cover;
  background-position: center;
}
[data-tab="music"] .spNowTitle{
  font-weight: 850;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width: 42ch;
}
[data-tab="music"] .spNowArtist{
  color: var(--sp-muted);
  font-size: 12px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
[data-tab="music"] .spControls{
  display:flex;
  align-items:center;
  gap:10px;
  flex: 1 1 auto;
  justify-content:center;
}
[data-tab="music"] .spCtl{
  border:1px solid var(--sp-border);
  background: rgba(0,0,0,.22);
  color: var(--sp-text);
  width: 38px;
  height: 38px;
  border-radius: 999px;
  cursor:pointer;
}
[data-tab="music"] .spCtlPlay{
  border:0;
  background: linear-gradient(135deg, var(--sp-green), rgba(29,185,84,.70));
  color:#071222;
  font-weight: 900;
}
[data-tab="music"] .spSeek{
  width: min(520px, 50vw);
  max-width: 680px;
}
[data-tab="music"] .spActions{
  min-width: 120px;
  display:flex;
  justify-content:flex-end;
}
[data-tab="music"] .spOpen{
  color: var(--sp-text);
  text-decoration:none;
  border:1px solid var(--sp-border);
  padding: 9px 12px;
  border-radius: 999px;
  background: rgba(0,0,0,.18);
  font-size: 12px;
}
[data-tab="music"] .spOpen:hover{
  border-color: rgba(29,185,84,.55);
}
@media (max-width: 780px){
  [data-tab="music"] .spTableHead,
  [data-tab="music"] .spTrack{
    grid-template-columns: 26px minmax(220px, 1.5fr) minmax(0, 0.8fr) 0px 140px;
  }
  [data-tab="music"] .spPrice,
  [data-tab="music"] .spColPrice{ display:none; }
  [data-tab="music"] .spPlayer{ gap:10px; }
  [data-tab="music"] .spSeek{ display:none; }
}

</style>
</head>
<body>
  <div class="shell" id="app">
    <aside class="side">
      <div>
        <div class="brand" title="Galaxy Games">GX</div>
        <nav class="nav" aria-label="Primary">
          <button class="iconbtn active" data-tab-target="home" title="Home">üè†</button>
          <button class="iconbtn" data-tab-target="games" title="Games">üéÆ</button>
          <button class="iconbtn" data-tab-target="music" title="Music">üéµ</button>
<button class="iconbtn" data-tab-target="television" title="Television">üì∫</button>
          <button class="iconbtn" data-tab-target="soundboard" title="Sound board">üéõÔ∏è</button>
          <button class="iconbtn" data-tab-target="about" title="About">‚ùî</button>
        </nav>
      </div>
      <div class="clock">
        <div class="t" id="clockTime"></div>
        <div id="clockDate"></div>
      </div>
    </aside>

    <main class="main">
      <div class="top">
        <div class="titleblock">
          <div class="h">Galaxy Games</div>
          <div class="sub">A clean dashboard for unblocked games, music previews, and embedded TV. Use the overlay for a distraction-free experience.</div>
          <div class="pills">
            <div class="pill">Ctrl/‚åò K: Search</div>
            <div class="pill">F: Fullscreen</div>
            <div class="pill">Esc: Close overlay</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn ghost" id="openK" title="Search (Ctrl/‚åò K)">Search</button>
          <button class="btn icon" id="themeBtn" title="Theme">Theme</button>
          <button class="btn icon" id="settingsBtn" title="Settings">Settings</button>
          <div class="seg" role="tablist" aria-label="Sections">
            <button class="active" data-tab-target="home">Home</button>
            <button data-tab-target="games">Games</button>
            <button data-tab-target="music">Music</button>
            <button data-tab-target="television">Television</button>
            <button data-tab-target="soundboard">Sound</button>
          </div>
        </div>
      </div>

      <section class="panel">
        <!-- HOME -->
        <div class="tab active" data-tab="home">
          <div class="hero">
            <div class="heroBox">
              <div class="heroTitle" id="welcomeTitle">Good to see you</div>
              <div class="heroSubtitle" id="welcomeSubtitle">Choose where you want to explore today</div>
              <div class="hint">Launch games in an overlay, favorite your picks, and jump back into recent sessions. Everything is stored locally in your browser.</div>
              <div class="row" style="margin-top:6px;">
                <button class="btn primary" id="startBtn">Start playing</button>
                <button class="btn" id="openRecentBtn">Open last played</button>
                <button class="btn ghost" data-tab-jump="music">Find music</button>
              </div>
              <div class="stats" style="margin-top:10px;">
                <div class="stat"><div class="n" id="statGames">‚Äî</div><div class="l">Games loaded</div></div>
                <div class="stat"><div class="n" id="statFav">‚Äî</div><div class="l">Favorites</div></div>
                <div class="stat"><div class="n" id="statRecent">‚Äî</div><div class="l">Recent launches</div></div>
              </div>
            </div>

            <div class="heroBox" style="background: linear-gradient(135deg, rgba(15,23,42,.55), rgba(168,85,247,.16));">
              <div class="h2">Quick picks</div>
              <div class="hint">Your favorites and recent launches appear here once you start using the dashboard.</div>
              <div class="grid" id="homeQuickGrid" style="grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));"></div>
              <div class="hint" id="homeQuickEmpty" style="display:none;">No favorites or recent items yet. Go to Games and click Play or ‚òÖ.</div>
            </div>
          </div>
        </div>

        <!-- GAMES -->
        <div class="tab" data-tab="games">
          <div class="row">
            <div>
              <div class="h2">Games</div>
              <div class="hint">Search, favorite, and launch. Favorites and recents are saved to your browser.</div>
            </div>
            <div class="row" style="gap:10px;">
              <div class="inputwrap">
                <input id="gameSearch" type="text" placeholder="Search games‚Ä¶" />
                <div class="ico">üîç</div>
              </div>
              <select id="gameSort" title="Sort">
                <option value="az">Sort: A ‚Üí Z</option>
                <option value="za">Sort: Z ‚Üí A</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="chips" id="gameChips">
              <div class="chip active" data-filter="all">All</div>
              <div class="chip" data-filter="fav">Favorites</div>
              <div class="chip" data-filter="recent">Recent</div>
            </div>
            <div class="badge" id="gamesCount">0 items</div>
          </div>

          <div class="grid" id="gameGrid"></div>
          <div class="hint" id="gamesEmpty" style="display:none;">No matching games.</div>
        </div>

        <!-- MUSIC -->
        
<div class="tab" data-tab="music">
  <div class="spHeader">
    <div class="spTitle">Music</div>
    <div class="spSub">Search iTunes and play 30‚Äësecond previews in a Spotify‚Äëstyle library.</div>
  </div>

  <div class="spToolbar">
    <div class="spSearch">
      <span class="spSearchIcon">üîç</span>
      <input id="musicSearch" type="text" placeholder="What do you want to listen to?" autocomplete="off" />
    </div>

    <div class="spFilters">
      <label class="spSelect">
        <span>Type</span>
        <select id="musicEntity" title="Type">
          <option value="song">Songs</option>
          <option value="album">Albums</option>
          <option value="musicVideo">Music videos</option>
        </select>
      </label>

      <label class="spSelect">
        <span>Country</span>
        <select id="musicCountry" title="Country">
          <option value="US">US</option>
          <option value="CA">CA</option>
          <option value="GB">GB</option>
          <option value="AU">AU</option>
        </select>
      </label>

      <label class="spSelect">
        <span>Results</span>
        <select id="musicLimit" title="Results limit">
          <option value="24">24</option>
          <option value="36">36</option>
          <option value="48">48</option>
        </select>
      </label>
    </div>
  </div>

  <div class="spChipsRow">
    <div class="chips" id="musicChips">
      <div class="chip active" data-m="all">All</div>
      <div class="chip" data-m="fav">Favorites</div>
    </div>
    <div class="badge" id="musicStatus">Type to search.</div>
  </div>

  <div class="spTableHead" aria-hidden="true">
    <div class="spCol spColNum">#</div>
    <div class="spCol spColTitle">Title</div>
    <div class="spCol spColAlbum">Album / Genre</div>
    <div class="spCol spColPrice">Price</div>
    <div class="spCol spColActions"></div>
  </div>

  <div class="spList" id="musicGrid"></div>
  <div class="hint" id="musicEmpty" style="display:none;">No results.</div>

  <!-- Bottom player (Spotify-style) -->
  <div class="spPlayer" id="musicMini">
    <div class="spNow">
      <div class="spNowArt" id="spNowArt"></div>
      <div class="spNowMeta">
        <div class="spNowTitle" id="nowTrack">Now playing</div>
        <div class="spNowArtist" id="nowArtist"></div>
      </div>
    </div>

    <div class="spControls">
      <button class="spCtl" id="musicStop" type="button" title="Stop">‚èπ</button>
      <button class="spCtl spCtlPlay" id="spPlayPause" type="button" title="Play/Pause">‚èØ</button>
      <input class="spSeek" id="audioSeek" type="range" min="0" max="100" step="1" value="0" aria-label="Seek" />
    </div>

    <div class="spActions">
      <a class="spOpen" id="musicOpen" href="#" target="_blank" rel="noopener">Open</a>
    </div>
  </div>
</div>
<div class="tab" data-tab="television">
          <div class="row">
            <div>
              <div class="h2">Television</div>
              <div class="hint">Open any embed in the overlay and hit fullscreen. (Some embeds restrict fullscreen depending on host.)</div>
            </div>
            <div class="badge">Tip: Use the overlay button ‚ÄúFullscreen‚Äù or press <b>F</b>.</div>
          </div>

          <div class="grid" id="tvGrid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));">
            <div class="card" data-tv>
              <div class="topline">
                <div class="left">
                  <div class="avatar" style="background-image: radial-gradient(circle at 30% 30%, rgba(56,189,248,.85), rgba(2,6,23,.45));"></div>
                  <div class="meta">
                    <div class="name">Disney</div>
                    <div class="sub">Embedded slideshow channel</div>
                  </div>
                </div>
                <div class="kbar">TV</div>
              </div>
              <iframe
                data-tv-embed
                src="https://docs.google.com/presentation/d/1cqMoS7rNvOX77938GusdWNi6mYVPOfETCVsAVW9I9ps/preview?slide=id.g2caa1804f1f_0_71"
                style="width:100%;height:260px;border-radius:14px;border:1px solid rgba(148,163,184,.18);"
                allowfullscreen
              ></iframe>
              <div class="actions">
                <button class="smallbtn" data-tv-open>Open</button>
                <button class="smallbtn primary" data-tv-full>Fullscreen</button>
              </div>
            </div>

            <div class="card" data-tv>
              <div class="topline">
                <div class="left">
                  <div class="avatar" style="background-image: radial-gradient(circle at 30% 30%, rgba(168,85,247,.75), rgba(2,6,23,.45));"></div>
                  <div class="meta">
                    <div class="name">Paramount</div>
                    <div class="sub">Embedded slideshow channel</div>
                  </div>
                </div>
                <div class="kbar">TV</div>
              </div>
              <iframe
                data-tv-embed
                src="https://docs.google.com/presentation/d/1CiZMdBm677M7EIus7gT89WPxwYPzXJQgwmXGv3sLAaw/preview?slide=id.g1b71f8bdb3c_2_77"
                style="width:100%;height:260px;border-radius:14px;border:1px solid rgba(148,163,184,.18);"
                allowfullscreen
              ></iframe>
              <div class="actions">
                <button class="smallbtn" data-tv-open>Open</button>
                <button class="smallbtn primary" data-tv-full>Fullscreen</button>
              </div>
            </div>
          </div>
        </div>

        <!-- SOUNDBOARD -->
        <div class="tab" data-tab="soundboard">
          <div class="row">
            <div>
              <div class="h2">Sound board</div>
              <div class="hint">Instant synth pads, plus a shortcut to the original soundboard game (if present in the feed).</div>
            </div>
            <button class="btn primary" id="launchSoundboard">Launch original board</button>
          </div>
          <div class="hint" id="sbRemote"></div>
          <div class="hint" id="sbStatus" style="min-height:1.2em;"></div>
          <div class="grid" id="sbGrid" style="grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));"></div>
        </div>

        <!-- ABOUT -->
        <div class="tab" data-tab="about">
          <div class="h2">About</div>
          <div class="hint" style="line-height:1.7; max-width: 72ch;">
            This is a single-file dashboard. It loads a public games feed, uses iTunes Search for music previews, and launches content in an overlay.
            Favorites and recents are stored in localStorage on your device only.
          </div>
          <div class="hint" style="margin-top:10px; line-height:1.7; max-width: 72ch;">
            Keyboard: <b>Ctrl/‚åò K</b> search, <b>F</b> fullscreen overlay, <b>Esc</b> close overlay.
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="frame">
      <div class="obar">
        <div class="left">
          <div class="dot"></div>
          <div class="ttl" id="overlayTitle">Overlay</div>
        </div>
        <div class="right">
          <button class="obarbtn" id="overlayOpen" title="Open in new tab">Open</button>
          <button class="obarbtn" id="overlayFs" title="Fullscreen (F)">Fullscreen</button>
          <button class="obarbtn" id="overlayClose" title="Close (Esc)">Close</button>
        </div>
      </div>
      <div style="position:relative; flex:1;">
        <iframe id="overlayFrame" allow="accelerometer; autoplay; fullscreen; clipboard-read; clipboard-write; gamepad;" referrerpolicy="no-referrer"></iframe>
        <div class="loading" id="overlayLoading"><div class="spinner"></div></div>
      </div>
    </div>
  </div>

  <!-- Command palette -->
  <div class="kmodal" id="kmodal" aria-hidden="true">
    <div class="kpanel" role="dialog" aria-modal="true" aria-label="Search">
      <div class="khead">
        <input id="kinput" type="text" placeholder="Search games, music, or actions‚Ä¶" />
        <div class="kbar">Esc</div>
      </div>
      <div class="klist" id="klist"></div>
    </div>
  </div>

  
  <!-- Settings Modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <div>
          <div class="h2" style="margin:0">Settings</div>
          <div class="hint">Changes are saved locally in your browser.</div>
        </div>
        <button class="btn ghost" id="settingsClose">Close</button>
      </div>

      <div class="modalBody">
        <div class="setGrid">
          <div class="setGroup">
            <div class="h3">Appearance</div>
            <label class="setRow">
              <span>Theme</span>
              <select id="setTheme" class="input">
                <option value="default">Default</option>
                <option value="neon">Neon</option>
                <option value="midnight">Midnight</option>
              </select>
            </label>
            <label class="setRow">
              <span>Card density</span>
              <select id="setDensity" class="input">
                <option value="comfortable">Comfortable</option>
                <option value="compact">Compact</option>
              </select>
            </label>
            <label class="setRow toggle">
              <span>Background effects</span>
              <input type="checkbox" id="setFx" />
            </label>
            <label class="setRow toggle">
              <span>Reduce motion</span>
              <input type="checkbox" id="setReduceMotion" />
            </label>
          </div>

          <div class="setGroup">
            <div class="h3">Behavior</div>
            <label class="setRow toggle">
              <span>Autoplay music previews</span>
              <input type="checkbox" id="setAutoplayPreview" />
            </label>
            <label class="setRow toggle">
              <span>Open overlay in fullscreen</span>
              <input type="checkbox" id="setOverlayFs" />
            </label>
            <label class="setRow">
              <span>Default tab</span>
              <select id="setDefaultTab" class="input">
                <option value="home">Home</option>
                <option value="games">Games</option>
                <option value="music">Music</option>
                <option value="television">Television</option>
              </select>
            </label>
          </div>

          <div class="setGroup">
            <div class="h3">Music</div>
            <label class="setRow">
              <span>Country</span>
              <input id="setMusicCountry" class="input" placeholder="US" />
            </label>
            <label class="setRow">
              <span>Result limit</span>
              <input id="setMusicLimit" class="input" type="number" min="5" max="50" step="5" />
            </label>
            <div class="hint">Tip: Albums usually don‚Äôt provide previews; songs do.</div>
          </div>

          <div class="setGroup">
            <div class="h3">Data</div>
            <div class="row" style="gap:10px; flex-wrap:wrap">
              <button class="btn ghost" id="clearFavorites">Clear favorites</button>
              <button class="btn ghost" id="clearRecents">Clear recents</button>
              <button class="btn ghost" id="clearMusicFav">Clear music favorites</button>
            </div>
            <div class="hint">This only clears local storage on this device/browser.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
    (function(){
      const app = document.getElementById('app');
      const themeBtn = document.getElementById('themeBtn');

      
      // Dynamic welcome message
      (function initWelcome(){
        const tEl = document.getElementById('welcomeTitle');
        const sEl = document.getElementById('welcomeSubtitle');
        if (!tEl || !sEl) return;

        const hour = new Date().getHours();
        const timeHint =
          hour < 5 ? 'Late night' :
          hour < 12 ? 'Good morning' :
          hour < 17 ? 'Good afternoon' :
          hour < 22 ? 'Good evening' : 'Late night';

        const titles = [
          'Good to see you',
          'Ready to explore?',
          'Welcome back',
          'Let‚Äôs play something',
          'New day, new adventure',
          'Pick your next vibe',
          'Press play on your day',
          timeHint
        ];

        const subtitles = [
          'Choose where you want to explore today',
          'Games, music, TV, and more‚Äîone click away',
          'Search, launch, and fullscreen instantly',
          'Your favorites are waiting',
          'Jump in‚Äîyour overlay is ready',
          'Find something new in seconds',
          'Make it loud. Make it fun.'
        ];

        const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];
        tEl.textContent = pick(titles);
        sEl.textContent = pick(subtitles);
      })();
// Theme
      const savedTheme = localStorage.getItem('gx_theme') || 'default';
      if (savedTheme === 'neon') document.documentElement.setAttribute('data-theme','neon');
      function toggleTheme(){
        const cur = document.documentElement.getAttribute('data-theme') || 'default';
        const next = cur === 'default' ? 'neon' : (cur === 'neon' ? 'midnight' : 'default');
        if (next === 'default'){
          document.documentElement.removeAttribute('data-theme');
        }else{
          document.documentElement.setAttribute('data-theme', next);
        }
        localStorage.setItem('gx_theme', next);
      }
      themeBtn.addEventListener('click', toggleTheme);

      // Settings (persisted)
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsModal = document.getElementById('settingsModal');
      const settingsClose = document.getElementById('settingsClose');

      const DEFAULT_SETTINGS = {
        theme: (localStorage.getItem('gx_theme') || 'default'),
        density: 'comfortable',
        fx: true,
        reduceMotion: false,
        autoplayPreview: false,
        overlayFullscreen: false,
        defaultTab: 'home',
        musicCountry: null,
        musicLimit: null
      };
      function loadSettings(){
        return Object.assign({}, DEFAULT_SETTINGS, lsGetJSON('gx_settings', {}));
      }
      function saveSettings(s){
        localStorage.setItem('gx_settings', JSON.stringify(s));
      }
      let SETTINGS = loadSettings();

      function applyTheme(mode){
        if (mode && mode !== 'default'){
          document.documentElement.setAttribute('data-theme', mode);
        }else{
          document.documentElement.removeAttribute('data-theme');
        }
        localStorage.setItem('gx_theme', mode || 'default');
        SETTINGS.theme = mode || 'default';
        saveSettings(SETTINGS);
      }

      function applyDensity(mode){
        document.documentElement.setAttribute('data-density', mode || 'comfortable');
        SETTINGS.density = mode || 'comfortable';
        saveSettings(SETTINGS);
      }

      function applyFx(on){
        document.documentElement.setAttribute('data-fx', on ? 'on' : 'off');
        SETTINGS.fx = !!on;
        saveSettings(SETTINGS);
      }

      function applyReduceMotion(on){
        document.documentElement.setAttribute('data-reduce-motion', on ? 'on' : 'off');
        SETTINGS.reduceMotion = !!on;
        saveSettings(SETTINGS);
      }

      function openSettings(){
        if (!settingsModal) return;
        // hydrate controls
        document.getElementById('setTheme').value = SETTINGS.theme || 'default';
        document.getElementById('setDensity').value = SETTINGS.density || 'comfortable';
        document.getElementById('setFx').checked = !!SETTINGS.fx;
        document.getElementById('setReduceMotion').checked = !!SETTINGS.reduceMotion;
        document.getElementById('setAutoplayPreview').checked = !!SETTINGS.autoplayPreview;
        document.getElementById('setOverlayFs').checked = !!SETTINGS.overlayFullscreen;
        document.getElementById('setDefaultTab').value = SETTINGS.defaultTab || 'home';
        document.getElementById('setMusicCountry').value = SETTINGS.musicCountry || (musicCountry?.value || 'US');
        document.getElementById('setMusicLimit').value = SETTINGS.musicLimit || (musicLimit?.value || 25);

        settingsModal.setAttribute('aria-hidden','false');
      }
      function closeSettings(){
        if (!settingsModal) return;
        settingsModal.setAttribute('aria-hidden','true');
      }

      if (settingsBtn){
        settingsBtn.addEventListener('click', openSettings);
      }
      if (settingsClose){
        settingsClose.addEventListener('click', closeSettings);
      }
      if (settingsModal){
        settingsModal.addEventListener('click', (e)=>{
          if (e.target === settingsModal) closeSettings();
        });
      }

      // wire controls
      const setThemeEl = document.getElementById('setTheme');
      const setDensityEl = document.getElementById('setDensity');
      const setFxEl = document.getElementById('setFx');
      const setReduceMotionEl = document.getElementById('setReduceMotion');
      const setAutoplayEl = document.getElementById('setAutoplayPreview');
      const setOverlayFsEl = document.getElementById('setOverlayFs');
      const setDefaultTabEl = document.getElementById('setDefaultTab');
      const setMusicCountryEl = document.getElementById('setMusicCountry');
      const setMusicLimitEl = document.getElementById('setMusicLimit');

      setThemeEl && setThemeEl.addEventListener('change', ()=> applyTheme(setThemeEl.value));
      setDensityEl && setDensityEl.addEventListener('change', ()=> applyDensity(setDensityEl.value));
      setFxEl && setFxEl.addEventListener('change', ()=> applyFx(setFxEl.checked));
      setReduceMotionEl && setReduceMotionEl.addEventListener('change', ()=> applyReduceMotion(setReduceMotionEl.checked));
      setAutoplayEl && setAutoplayEl.addEventListener('change', ()=>{ SETTINGS.autoplayPreview = setAutoplayEl.checked; saveSettings(SETTINGS); });
      setOverlayFsEl && setOverlayFsEl.addEventListener('change', ()=>{ SETTINGS.overlayFullscreen = setOverlayFsEl.checked; saveSettings(SETTINGS); });
      setDefaultTabEl && setDefaultTabEl.addEventListener('change', ()=>{ SETTINGS.defaultTab = setDefaultTabEl.value; saveSettings(SETTINGS); });
      setMusicCountryEl && setMusicCountryEl.addEventListener('change', ()=>{
        SETTINGS.musicCountry = (setMusicCountryEl.value || '').trim().toUpperCase() || 'US';
        saveSettings(SETTINGS);
        if (musicCountry) musicCountry.value = SETTINGS.musicCountry;
      });
      setMusicLimitEl && setMusicLimitEl.addEventListener('change', ()=>{
        const v = parseInt(setMusicLimitEl.value,10);
        SETTINGS.musicLimit = Number.isFinite(v) ? v : 25;
        saveSettings(SETTINGS);
        if (musicLimit) musicLimit.value = SETTINGS.musicLimit;
      });

      // Data clear
      const clearFavoritesBtn = document.getElementById('clearFavorites');
      const clearRecentsBtn = document.getElementById('clearRecents');
      const clearMusicFavBtn = document.getElementById('clearMusicFav');

      clearFavoritesBtn && clearFavoritesBtn.addEventListener('click', ()=>{
        localStorage.removeItem('gx_favorites');
        localStorage.removeItem('gx_recent');
        location.reload();
      });
      clearRecentsBtn && clearRecentsBtn.addEventListener('click', ()=>{
        localStorage.removeItem('gx_recent');
        location.reload();
      });
      clearMusicFavBtn && clearMusicFavBtn.addEventListener('click', ()=>{
        localStorage.removeItem('gx_music_favorites');
        location.reload();
      });

      // Apply settings on load
      applyTheme(SETTINGS.theme);
      applyDensity(SETTINGS.density);
      applyFx(SETTINGS.fx);
      applyReduceMotion(SETTINGS.reduceMotion);


      // Clock
      const ct = document.getElementById('clockTime');
      const cd = document.getElementById('clockDate');
      function tick(){
        const d = new Date();
        ct.textContent = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        cd.textContent = d.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});
      }
      tick(); setInterval(tick, 1000 * 20);

      // Tabs
      function setTab(tab){
        document.querySelectorAll('.tab').forEach(p => p.classList.toggle('active', p.getAttribute('data-tab') === tab));
        document.querySelectorAll('[data-tab-target]').forEach(b => b.classList.toggle('active', b.getAttribute('data-tab-target') === tab));
      }
      document.addEventListener('click', (e)=>{
        const t = e.target.closest('[data-tab-target]');
        if (t){ setTab(t.getAttribute('data-tab-target')); }
        const j = e.target.closest('[data-tab-jump]');
        if (j){ setTab(j.getAttribute('data-tab-jump')); }
      });

      document.getElementById('startBtn').addEventListener('click', ()=>{ setTab('games'); document.getElementById('gameSearch').focus(); });

      // Storage helpers
      const LS_FAV = 'gx_favorites';
      const LS_REC = 'gx_recent';
      const LS_MFAV = 'gx_music_favorites';

      const readJson = (k, def) => {
        try{
          const v = localStorage.getItem(k);
          return v ? JSON.parse(v) : def;
        }catch(e){ return def; }
      };
      const writeJson = (k, v) => localStorage.setItem(k, JSON.stringify(v));

      // Overlay
      const overlay = document.getElementById('overlay');
      const oframe = document.getElementById('overlayFrame');
      const otitle = document.getElementById('overlayTitle');
      const oopen = document.getElementById('overlayOpen');
      const ofs = document.getElementById('overlayFs');
      const oclose = document.getElementById('overlayClose');
      const oloading = document.getElementById('overlayLoading');

      let overlayUrl = '';
      function showLoading(on){ oloading.style.display = on ? 'grid' : 'none'; }

      function openOverlayUrl(url, title){
        if (!url) return;
        overlayUrl = url;
        otitle.textContent = title || 'Overlay';
        oopen.onclick = ()=> window.open(url, '_blank', 'noopener');
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
        showLoading(true);

        // For direct embeds, just set src.
        oframe.onload = ()=> showLoading(false);
        oframe.src = url;
      }

      function closeOverlay(){
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
        showLoading(false);
        try{ oframe.src = 'about:blank'; }catch(e){}
        overlayUrl = '';
      }

      async function toggleFullscreen(){
        const isFs = document.fullscreenElement === overlay;
        if (!document.fullscreenEnabled) return;
        try{
          if (isFs) await document.exitFullscreen();
          else await overlay.requestFullscreen();
        }catch(e){}
      }

      overlay.addEventListener('click', (e)=>{ if (e.target === overlay) closeOverlay(); });
      oclose.addEventListener('click', closeOverlay);
      ofs.addEventListener('click', toggleFullscreen);

      // Keyboard shortcuts
      document.addEventListener('keydown', (e)=>{
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k'){
          e.preventDefault();
          openK();
          return;
        }
        if (e.key === 'Escape'){
          if (kmodalOpen()) closeK();
          else closeOverlay();
        }
        if (e.key.toLowerCase() === 'f'){
          if (overlay.style.display === 'flex') toggleFullscreen();
        }
      });

      // TV buttons
      document.querySelectorAll('[data-tv]').forEach(card=>{
        const iframe = card.querySelector('[data-tv-embed]');
        const openBtn = card.querySelector('[data-tv-open]');
        const fullBtn = card.querySelector('[data-tv-full]');
        const name = card.querySelector('.name')?.textContent?.trim() || 'TV';
        const src = iframe?.getAttribute('src') || '';
        if (openBtn) openBtn.addEventListener('click', ()=> openOverlayUrl(src, name));
        if (fullBtn) fullBtn.addEventListener('click', async ()=>{
          openOverlayUrl(src, name);
          // Attempt fullscreen after a short delay for gesture reliability
          setTimeout(()=> toggleFullscreen(), 200);
        });
      });

      // Command palette
      const kmodal = document.getElementById('kmodal');
      const kinput = document.getElementById('kinput');
      const klist = document.getElementById('klist');
      const openKBtn = document.getElementById('openK');

      function kmodalOpen(){ return kmodal.style.display === 'flex'; }
      function openK(){
        kmodal.style.display = 'flex';
        kmodal.setAttribute('aria-hidden','false');
        buildKList('');
        setTimeout(()=> kinput.focus(), 0);
      }
      function closeK(){
        kmodal.style.display = 'none';
        kmodal.setAttribute('aria-hidden','true');
      }
      openKBtn.addEventListener('click', openK);
      kmodal.addEventListener('click', (e)=>{ if (e.target === kmodal) closeK(); });
      kinput.addEventListener('input', ()=> buildKList(kinput.value || ''));

      // Data + rendering
      const ZONES_URL = "https://cdn.jsdelivr.net/gh/Notrexed/assets@latest/allzone.json";
      const COVER_URL = "https://cdn.jsdelivr.net/gh/Notrexed/covers@main";
      const HTML_URL  = "https://cdn.jsdelivr.net/gh/Notrexed/html@latest";

      const gameGrid = document.getElementById('gameGrid');
      const gameSearch = document.getElementById('gameSearch');
      const gameSort = document.getElementById('gameSort');
      const gamesEmpty = document.getElementById('gamesEmpty');
      const gamesCount = document.getElementById('gamesCount');
      const gameChips = document.getElementById('gameChips');

      const homeQuickGrid = document.getElementById('homeQuickGrid');
      const homeQuickEmpty = document.getElementById('homeQuickEmpty');

      const statGames = document.getElementById('statGames');
      const statFav = document.getElementById('statFav');
      const statRecent = document.getElementById('statRecent');
      const openRecentBtn = document.getElementById('openRecentBtn');

      let zones = [];
      let soundboardZone = null;
      let gameFilter = 'all';

      function isSoundboardZone(z){
        const n = (z?.name || '').toLowerCase();
        return n.includes('sound') && n.includes('board');
      }
      function buildCoverUrl(z){
        let c = String(z?.cover || '');
        return c.replace("{COVER_URL}", COVER_URL).replace("{HTML_URL}", HTML_URL);
      }
      function buildZoneHtmlUrl(z){
        let u = String(z?.url || '');
        return u.replace("{HTML_URL}", HTML_URL).replace("{COVER_URL}", COVER_URL);
      }

      const getFav = ()=> new Set(readJson(LS_FAV, []));
      const setFav = (set)=> writeJson(LS_FAV, Array.from(set));
      const getRecent = ()=> readJson(LS_REC, []);
      const pushRecent = (item)=>{
        const rec = getRecent().filter(x=> x && x.id !== item.id);
        rec.unshift({id:item.id, name:item.name, cover:item.cover, url:item.url, ts: Date.now()});
        writeJson(LS_REC, rec.slice(0, 12));
      }

      function updateStats(){
        statGames.textContent = zones.filter(z=> z && !isSoundboardZone(z) && z.id !== -1 && !(String(z.name||'').toLowerCase().includes('ovo'))).length;
        statFav.textContent = getFav().size;
        statRecent.textContent = getRecent().length;
      }

      function renderGameCard(z){
        const fav = getFav();
        const on = fav.has(z.id);

        const card = document.createElement('div');
        card.className = 'card';
        card.tabIndex = 0;

        const top = document.createElement('div');
        top.className = 'topline';

        const left = document.createElement('div');
        left.className = 'left';

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        const cover = buildCoverUrl(z);
        if (cover) avatar.style.backgroundImage = `url(${cover})`;

        const meta = document.createElement('div');
        meta.className = 'meta';
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = z.name || 'Untitled';
        const sub = document.createElement('div');
        sub.className = 'sub';
        sub.textContent = z.author || (z.id != null ? ('ID ' + z.id) : 'Click to play');
        meta.appendChild(name); meta.appendChild(sub);

        left.appendChild(avatar); left.appendChild(meta);

        const star = document.createElement('button');
        star.className = 'star' + (on ? ' on' : '');
        star.type = 'button';
        star.title = on ? 'Unfavorite' : 'Favorite';
        star.textContent = on ? '‚òÖ' : '‚òÜ';
        star.addEventListener('click', (e)=>{
          e.stopPropagation();
          const s = getFav();
          if (s.has(z.id)) s.delete(z.id); else s.add(z.id);
          setFav(s);
          applyGames();
          renderHomeQuick();
          updateStats();
        });

        top.appendChild(left);
        top.appendChild(star);

        const actions = document.createElement('div');
        actions.className = 'actions';

        const play = document.createElement('button');
        play.className = 'smallbtn primary';
        play.type = 'button';
        play.textContent = 'Play';
        play.addEventListener('click', (e)=>{ e.stopPropagation(); launchGame(z); });

        const open = document.createElement('button');
        open.className = 'smallbtn';
        open.type = 'button';
        open.textContent = 'Open';
        open.addEventListener('click', (e)=>{ e.stopPropagation(); openOverlayUrl(buildZoneHtmlUrl(z), z.name); });

        actions.appendChild(open);
        actions.appendChild(play);

        card.appendChild(top);
        card.appendChild(actions);

        card.addEventListener('click', ()=> launchGame(z));
        card.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') launchGame(z); });

        return card;
      }

      function launchGame(z){
        pushRecent(z);
        updateStats();
        renderHomeQuick();

        // Load HTML into iframe via doc.write so scripts run properly.
        const url = buildZoneHtmlUrl(z);
        overlayUrl = url;
        otitle.textContent = z.name || 'Game';
        oopen.onclick = ()=> window.open(url, '_blank', 'noopener');
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
        showLoading(true);

        oframe.onload = ()=> showLoading(false);

        fetch(url + '?t=' + Date.now())
          .then(r=>r.text())
          .then(html=>{
            const doc = oframe.contentWindow.document;
            doc.open(); doc.write(html); doc.close();
          })
          .catch(()=>{
            const doc = oframe.contentWindow.document;
            doc.open();
            doc.write("<body style='margin:0;display:flex;align-items:center;justify-content:center;background:#020617;color:#e5e7eb;font-family:sans-serif;'>Failed to load game.</body>");
            doc.close();
            showLoading(false);
          });
      }

      function applyGames(){
        const q = (gameSearch.value || '').trim().toLowerCase();
        let list = zones
          .filter(z=>z && z.id !== -1)
          .filter(z=>!isSoundboardZone(z))
          .filter(z=>!(String(z.name||'').toLowerCase().includes('ovo')));

        const fav = getFav();
        const rec = new Set(getRecent().map(x=>x.id));

        if (gameFilter === 'fav') list = list.filter(z=> fav.has(z.id));
        if (gameFilter === 'recent') list = list.filter(z=> rec.has(z.id));
        if (q) list = list.filter(z=> (z.name||'').toLowerCase().includes(q));

        list.sort((a,b)=>{
          const an = (a.name||'').toLowerCase();
          const bn = (b.name||'').toLowerCase();
          return gameSort.value === 'za' ? bn.localeCompare(an) : an.localeCompare(bn);
        });

        gameGrid.innerHTML = '';
        list.forEach(z=> gameGrid.appendChild(renderGameCard(z)));

        gamesEmpty.style.display = list.length ? 'none' : 'block';
        gamesCount.textContent = list.length + ' items';
      }

      // Quick picks on Home (favorites + recent)
      function renderHomeQuick(){
        const fav = getFav();
        const rec = getRecent();
        const recById = new Map(rec.map(x=>[x.id, x]));

        const picks = [];
        // Favorites first (up to 4)
        zones.forEach(z=>{
          if (picks.length >= 4) return;
          if (z && fav.has(z.id)) picks.push(z);
        });

        // Then recent (up to 6 total)
        for (const r of rec){
          if (picks.length >= 6) break;
          const z = zones.find(x=>x && x.id === r.id);
          if (z && !picks.some(p=>p.id === z.id)) picks.push(z);
        }

        homeQuickGrid.innerHTML = '';
        if (!picks.length){
          homeQuickEmpty.style.display = 'block';
          return;
        }
        homeQuickEmpty.style.display = 'none';
        picks.forEach(z=> homeQuickGrid.appendChild(renderGameCard(z)));
      }

      openRecentBtn.addEventListener('click', ()=>{
        const rec = getRecent();
        if (!rec.length) return;
        const z = zones.find(x=>x && x.id === rec[0].id);
        if (z) launchGame(z);
        else openOverlayUrl(rec[0].url || '', rec[0].name || 'Recent');
      });

      gameSearch.addEventListener('input', applyGames);
      gameSort.addEventListener('change', applyGames);
      gameChips.addEventListener('click', (e)=>{
        const c = e.target.closest('.chip');
        if (!c) return;
        gameFilter = c.getAttribute('data-filter');
        gameChips.querySelectorAll('.chip').forEach(x=>x.classList.toggle('active', x === c));
        applyGames();
      });

      // Soundboard pads
      const sbGrid = document.getElementById('sbGrid');
      const sbRemote = document.getElementById('sbRemote');
      const sbStatus = document.getElementById('sbStatus');
      const launchSoundboard = document.getElementById('launchSoundboard');

      const pads = [
        {tag:'Arcade', label:'Laser Sweep', hint:'Sharp sci-fi zap', tones:[{freq:760,d:0.18,t:'sawtooth'},{freq:280,d:0.22,t:'sawtooth',delay:0.02}]},
        {tag:'Retro', label:'Coin Pickup', hint:'Reward ping', tones:[{freq:980,d:0.12,t:'triangle'},{freq:1280,d:0.16,t:'square',delay:0.02}]},
        {tag:'Hype', label:'Air Horn', hint:'Crowd blast', tones:[{freq:220,d:0.45,t:'square',peak:0.55}]},
        {tag:'Soft', label:'Ping', hint:'Notification', tones:[{freq:660,d:0.12,t:'sine'},{freq:880,d:0.16,t:'triangle',delay:0.05}]},
        {tag:'Sci‚ÄëFi', label:'Power Down', hint:'Descending tone', tones:[{freq:640,d:0.16,t:'triangle'},{freq:320,d:0.22,t:'sine',delay:0.02}]},
        {tag:'Beat', label:'Drum Hit', hint:'Kick thump', tones:[{freq:90,d:0.24,t:'sine',peak:0.6},{freq:60,d:0.14,t:'sine',delay:0.02,peak:0.45}]},
      ];

      let audioCtx = null;
      function setSb(msg, color){
        sbStatus.textContent = msg || '';
        sbStatus.style.color = color || 'var(--muted)';
      }
      function ensureCtx(){
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
      }
      function playPad(p){
        try{
          ensureCtx();
          const now = audioCtx.currentTime;
          p.tones.forEach(t=>{
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = t.t || 'sine';
            o.frequency.value = t.freq || 440;
            const start = now + (t.delay || 0);
            const dur = t.d || 0.2;
            const peak = t.peak || 0.35;

            g.gain.setValueAtTime(0.0001, start);
            g.gain.exponentialRampToValueAtTime(peak, start + 0.02);
            g.gain.exponentialRampToValueAtTime(0.0001, start + dur);

            o.connect(g); g.connect(audioCtx.destination);
            o.start(start); o.stop(start + dur + 0.02);
          });
          setSb('Playing: ' + p.label, 'var(--accent)');
        }catch(e){
          setSb('Audio blocked by browser settings.', 'var(--bad)');
        }
      }
      function renderPads(){
        sbGrid.innerHTML = '';
        pads.forEach(p=>{
          const c = document.createElement('div');
          c.className = 'card';
          c.style.cursor = 'pointer';
          c.innerHTML = `
            <div class="topline">
              <div class="left">
                <div class="avatar" style="background-image: radial-gradient(circle at 30% 30%, rgba(56,189,248,.35), rgba(2,6,23,.45));"></div>
                <div class="meta">
                  <div class="name">${p.label}</div>
                  <div class="sub">${p.hint}</div>
                </div>
              </div>
              <div class="kbar">${p.tag}</div>
            </div>
            <div class="hint">Tap to play</div>
          `;
          c.addEventListener('click', ()=> playPad(p));
          sbGrid.appendChild(c);
        });
      }

      function updateSbRemote(){
        const z = soundboardZone;
        if (z){
          sbRemote.textContent = `Ready: "${z.name}" can be launched here.`;
          sbRemote.style.color = 'var(--good)';
        }else{
          sbRemote.textContent = 'Looking for the original Sound Board game in the feed‚Ä¶';
          sbRemote.style.color = 'var(--muted)';
        }
      }

      launchSoundboard.addEventListener('click', ()=>{
        if (!soundboardZone){
          setSb("Original Sound Board isn't loaded yet.", 'var(--bad)');
          return;
        }
        launchGame(soundboardZone);
      });

      // Music
      const musicGrid = document.getElementById('musicGrid');
      const musicSearch = document.getElementById('musicSearch');
      const musicEntity = document.getElementById('musicEntity');
      const musicCountry = document.getElementById('musicCountry');
      const musicLimit = document.getElementById('musicLimit');
      const musicStatus = document.getElementById('musicStatus');
      const musicEmpty = document.getElementById('musicEmpty');
      const musicChips = document.getElementById('musicChips');

      const musicMini = document.getElementById('musicMini');
      const nowTrack = document.getElementById('nowTrack');
      const nowArtist = document.getElementById('nowArtist');
      const musicStop = document.getElementById('musicStop');
      const musicOpen = document.getElementById('musicOpen');
      const audioSeek = document.getElementById('audioSeek');

      const getMusicFav = ()=> new Set(readJson(LS_MFAV, []));
      const setMusicFav = (s)=> writeJson(LS_MFAV, Array.from(s));

      let musicFilter = 'all';
      let musicAbort = null;
      let audio = new Audio();
      audio.preload = 'none';
      let seekTimer = null;
      audio.addEventListener('ended', ()=>{ if (spPlayPause) spPlayPause.textContent = '‚èØ'; });
      audio.addEventListener('pause', ()=>{ if (spPlayPause && audio.currentTime>0 && !audio.ended) spPlayPause.textContent = '‚èØ'; });
      audio.addEventListener('play', ()=>{ if (spPlayPause) spPlayPause.textContent = '‚è∏'; });

      function stopAudio(){
        try{ audio.pause(); audio.currentTime = 0; }catch(e){}
        musicMini.style.display = 'none';
        if (spPlayPause) spPlayPause.textContent = '‚èØ';
        if (seekTimer) clearInterval(seekTimer);
      }
      musicStop.addEventListener('click', stopAudio);
      if (spPlayPause){
        spPlayPause.addEventListener('click', ()=>{
          if (!audio.src) return;
          if (audio.paused) audio.play().catch(()=>{});
          else audio.pause();
        });
      }


      function fmtMoney(v, currency){
        if (v == null) return '';
        try{
          return new Intl.NumberFormat([], {style:'currency', currency: currency || 'USD'}).format(v);
        }catch(e){ return '$' + v; }
      }

      function playPreview(item){
        if (!item.previewUrl){
          musicStatus.textContent = 'No preview available for this item.';
          return;
        }
        const art = item.artworkUrl100 || item.artworkUrl60 || '';
        if (spNowArt){
          if (art) spNowArt.style.backgroundImage = `url(${art.replace('100x100','300x300')})`;
          else spNowArt.style.backgroundImage = '';
        }

        audio.src = item.previewUrl;
        audio.play().catch(()=>{});
        musicMini.style.display = 'flex';
        nowTrack.textContent = item.trackName || item.collectionName || 'Now playing';
        nowArtist.textContent = item.artistName || '';
        musicOpen.href = item.trackViewUrl || item.collectionViewUrl || '#';
        audioSeek.value = 0;
        if (spPlayPause) spPlayPause.textContent = '‚è∏';

        if (seekTimer) clearInterval(seekTimer);
        seekTimer = setInterval(()=>{
          if (!audio.duration || isNaN(audio.duration)) return;
          const pct = Math.min(100, Math.max(0, (audio.currentTime / audio.duration) * 100));
          audioSeek.value = String(Math.round(pct));
        }, 250);
      }

      audioSeek.addEventListener('input', ()=>{
        if (!audio.duration || isNaN(audio.duration)) return;
        const pct = Number(audioSeek.value || 0) / 100;
        audio.currentTime = pct * audio.duration;
      });

      function musicCard(item){
        const fav = getMusicFav();
        const key = String(item.trackId || item.collectionId || item.artistId || '');
        const on = key && fav.has(key);

        const art = item.artworkUrl100 || item.artworkUrl60 || '';
        const title = item.trackName || item.collectionName || item.artistName || 'Untitled';
        const artist = item.artistName || item.collectionCensoredName || '';
        const album = (item.collectionName && item.trackName) ? item.collectionName : (item.primaryGenreName || '');
        const price = (item.trackPrice != null) ? fmtMoney(item.trackPrice, item.currency) :
                      (item.collectionPrice != null) ? fmtMoney(item.collectionPrice, item.currency) : '';
        const openUrl = item.trackViewUrl || item.collectionViewUrl || item.artistViewUrl || '#';

        const row = document.createElement('div');
        row.className = 'spTrack';
        row.setAttribute('role','button');
        row.setAttribute('tabindex','0');

        // Row number (filled by renderer)
        const n = document.createElement('div');
        n.className = 'spNum';
        n.textContent = '‚Ä¢';

        const titleCell = document.createElement('div');
        titleCell.className = 'spTitleCell';

        const img = document.createElement('div');
        img.className = 'spArt';
        if (art) img.style.backgroundImage = `url(${art.replace('100x100','300x300')})`;

        const meta = document.createElement('div');
        meta.className = 'spMeta';
        meta.innerHTML = `<div class="t"></div><div class="a"></div>`;
        meta.querySelector('.t').textContent = title;
        meta.querySelector('.a').textContent = artist;

        titleCell.appendChild(img);
        titleCell.appendChild(meta);

        const alb = document.createElement('div');
        alb.className = 'spAlbum';
        alb.textContent = album;

        const pr = document.createElement('div');
        pr.className = 'spPrice';
        pr.textContent = price;

        const btns = document.createElement('div');
        btns.className = 'spBtns';

        const heart = document.createElement('button');
        heart.className = 'spBtn icon';
        heart.type = 'button';
        heart.textContent = on ? '‚ô•' : '‚ô°';
        heart.title = on ? 'Unfavorite' : 'Favorite';
        heart.addEventListener('click', (e)=>{
          e.stopPropagation();
          const s = getMusicFav();
          if (on) s.delete(key); else s.add(key);
          setMusicFav(s);
          applyMusicLastResults();
          updateStats();
        });

        const open = document.createElement('a');
        open.className = 'spBtn';
        open.textContent = 'Open';
        open.href = openUrl;
        open.target = '_blank';
        open.rel = 'noopener';
        open.addEventListener('click', (e)=> e.stopPropagation());

        const play = document.createElement('button');
        play.className = 'spBtn green';
        play.type = 'button';
        play.textContent = item.previewUrl ? 'Play' : 'No preview';
        play.disabled = !item.previewUrl;
        play.addEventListener('click', (e)=>{ e.stopPropagation(); playPreview(item); });

        btns.appendChild(heart);
        btns.appendChild(open);
        btns.appendChild(play);

        row.appendChild(n);
        row.appendChild(titleCell);
        row.appendChild(alb);
        row.appendChild(pr);
        row.appendChild(btns);

        row.addEventListener('click', ()=> item.previewUrl ? playPreview(item) : window.open(openUrl,'_blank','noopener'));
        row.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); row.click(); }});

        // store key for numbering
        row.dataset.mkey = key;

        return row;
      }


      let lastMusicResults = [];
      function applyMusicLastResults(){
        const fav = getMusicFav();
        let list = lastMusicResults.slice();
        if (musicFilter === 'fav'){
          list = list.filter(it=>{
            const key = String(it.trackId || it.collectionId || it.artistId || '');
            return key && fav.has(key);
          });
        }
        musicGrid.innerHTML = '';
        list.forEach((it, i)=>{
          const el = musicCard(it);
          const num = el.querySelector('.spNum');
          if (num) num.textContent = String(i + 1);
          musicGrid.appendChild(el);
        });
        musicEmpty.style.display = list.length ? 'none' : 'block';
        musicStatus.textContent = list.length ? (list.length + ' results') : 'No results.';
      }


      function itunesJsonp(apiUrl){
        return new Promise((resolve, reject)=>{
          const cb = 'gx_itunes_cb_' + Math.random().toString(36).slice(2);
          const s = document.createElement('script');
          const timeout = setTimeout(()=>{
            cleanup();
            reject(new Error('JSONP timeout'));
          }, 12000);

          function cleanup(){
            clearTimeout(timeout);
            try{ delete window[cb]; }catch(e){ window[cb] = undefined; }
            if (s.parentNode) s.parentNode.removeChild(s);
          }

          window[cb] = (data)=>{
            cleanup();
            resolve(data);
          };

          s.onerror = ()=>{
            cleanup();
            reject(new Error('JSONP error'));
          };

          const join = apiUrl.includes('?') ? '&' : '?';
          s.src = apiUrl + join + 'callback=' + encodeURIComponent(cb);
          document.body.appendChild(s);
        });
      }

      async function doMusicSearch(){
        const term = (musicSearch.value || '').trim();
        if (!term){
          lastMusicResults = [];
          applyMusicLastResults();
          musicStatus.textContent = 'Type to search.';
          return;
        }

        if (musicAbort) musicAbort.abort();
        musicAbort = new AbortController();

        const entity = musicEntity.value;
        const country = musicCountry.value;
        const limit = musicLimit.value;

        // iTunes Search API uses media/entity combinations
        const media = (entity === 'musicVideo') ? 'musicVideo' : 'music';
        const ent = entity; // song | album | musicVideo

        const url = 'https://itunes.apple.com/search'
          + '?term=' + encodeURIComponent(term)
          + '&media=' + encodeURIComponent(media)
          + '&entity=' + encodeURIComponent(ent)
          + '&limit=' + encodeURIComponent(limit)
          + '&country=' + encodeURIComponent(country);

        musicStatus.textContent = 'Searching‚Ä¶';
        musicEmpty.style.display = 'none';
        musicGrid.innerHTML = '';

        try{
          const res = await fetch(url, { signal: musicAbort.signal });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          lastMusicResults = Array.isArray(data.results) ? data.results : [];
          applyMusicLastResults();
        }catch(e){
          if (e.name === 'AbortError') return;
          try{
            // Fallback for environments where CORS blocks fetch(): JSONP
            const data = await itunesJsonp(url);
            lastMusicResults = Array.isArray(data?.results) ? data.results : [];
            applyMusicLastResults();
            return;
          }catch(e2){
            musicStatus.textContent = 'Search failed (network/CORS/API error).';
            musicEmpty.style.display = 'block';
          }
        }
      }

      let musicDebounce = null;
      function scheduleMusic(){
        if (musicDebounce) clearTimeout(musicDebounce);
        musicDebounce = setTimeout(doMusicSearch, 320);
      }

      musicSearch.addEventListener('input', scheduleMusic);
      musicEntity.addEventListener('change', doMusicSearch);
      musicCountry.addEventListener('change', doMusicSearch);
      musicLimit.addEventListener('change', doMusicSearch);

      musicChips.addEventListener('click', (e)=>{
        const c = e.target.closest('.chip');
        if (!c) return;
        musicFilter = c.getAttribute('data-m');
        musicChips.querySelectorAll('.chip').forEach(x=>x.classList.toggle('active', x === c));
        applyMusicLastResults();
      });

      // Init
      async function initGames(){
        try{
          const res = await fetch(ZONES_URL + '?t=' + Date.now());
          const data = await res.json();
          zones = Array.isArray(data) ? data : [];
          soundboardZone = zones.find(z=>isSoundboardZone(z)) || null;
        }catch(e){
          zones = [];
        }
        updateStats();
        renderHomeQuick();
        applyGames();
        updateSbRemote();
        renderPads();
        buildKList('');
      }

      // Build command palette list (actions + games + quick music actions)
      function buildKList(q){
        const qq = (q||'').trim().toLowerCase();
        const items = [];

        const addAction = (name, sub, fn, keyHint)=>{
          items.push({kind:'action', name, sub, fn, keyHint});
        };

        addAction('Go to Games', 'Browse and launch games', ()=>{ closeK(); setTab('games'); gameSearch.focus(); }, 'G');
        addAction('Go to Music', 'Search iTunes previews', ()=>{ closeK(); setTab('music'); musicSearch.focus(); }, 'M');
        addAction('Go to Television', 'Open TV embeds', ()=>{ closeK(); setTab('television'); }, 'T');
        addAction('Toggle Theme', 'Default / Neon', ()=>{ toggleTheme(); closeK(); }, '');

        const fav = getFav();
        zones
          .filter(z=>z && z.id !== -1 && !isSoundboardZone(z) && !(String(z.name||'').toLowerCase().includes('ovo')))
          .slice(0, 400)
          .forEach(z=>{
            items.push({
              kind:'game',
              name: z.name || 'Untitled',
              sub: fav.has(z.id) ? 'Favorite game' : (z.author || 'Game'),
              fn: ()=>{ closeK(); launchGame(z); },
              keyHint: 'Play'
            });
          });

        const filtered = !qq ? items : items.filter(it =>
          (it.name || '').toLowerCase().includes(qq) || (it.sub || '').toLowerCase().includes(qq)
        ).slice(0, 60);

        klist.innerHTML = '';
        filtered.slice(0, 60).forEach(it=>{
          const el = document.createElement('div');
          el.className = 'kitem';
          el.innerHTML = `
            <div class="l">
              <div class="avatar" style="width:30px;height:30px;border-radius:12px;"></div>
              <div style="min-width:0;">
                <div class="n">${escapeHtml(it.name)}</div>
                <div class="s">${escapeHtml(it.sub || '')}</div>
              </div>
            </div>
            <div class="r">
              ${it.keyHint ? `<div class="kbar">${escapeHtml(it.keyHint)}</div>` : ''}
            </div>
          `;
          el.addEventListener('click', ()=> it.fn && it.fn());
          klist.appendChild(el);
        });
      }

      

      // Local storage helpers (JSON)
      function lsGetJSON(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if (raw == null) return fallback;
          return JSON.parse(raw);
        }catch(e){ return fallback; }
      }
      function lsSetJSON(key, val){
        try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){}
      }

function escapeHtml(s){
        return String(s || '')
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'","&#039;");
      }

      try{ if (typeof setTab==='function' && SETTINGS && SETTINGS.defaultTab) setTab(SETTINGS.defaultTab); }catch(e){}

      initGames();
    })();
  </script>
</body>
</html>